(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[362],{8748:function(e,t,s){Promise.resolve().then(s.bind(s,8186))},1671:function(e,t,s){"use strict";s.d(t,{Z:function(){return r}});let r=(0,s(9205).Z)("CircleCheckBig",[["path",{d:"M22 11.08V12a10 10 0 1 1-5.93-9.14",key:"g774vq"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]])},8186:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return f}});var r=s(7437),n=s(7766),a=s(9376),l=s(2265),i=s(1837),c=s(3552),o=s(1939),d=s(8729),u=s(2660),x=s(1671),m=s(2093),g=s(5710);let h={Low:"bg-gray-100 text-gray-700",Medium:"bg-blue-100 text-blue-700",High:"bg-orange-100 text-orange-700",Critical:"bg-red-100 text-red-700"},p={Open:"bg-yellow-100 text-yellow-700","In Progress":"bg-blue-100 text-blue-700","Awaiting Customer":"bg-purple-100 text-purple-700",Escalated:"bg-orange-100 text-orange-700",Resolved:"bg-green-100 text-green-700",Closed:"bg-gray-100 text-gray-700"};function f(){var e,t,s,f,b;let{user:v,isLoading:y}=(0,n.a)(),j=parseInt((0,a.useParams)().id),[w,N]=(0,l.useState)(null),[k,_]=(0,l.useState)([]),[C,T]=(0,l.useState)(""),[E,R]=(0,l.useState)(!0),[A,S]=(0,l.useState)(!1),M=(0,l.useRef)(null),L=(0,l.useRef)(0);(0,o.r)(k,null==v?void 0:v.id,"agent"),(0,l.useEffect)(()=>{if(k.length>L.current){var e;null===(e=M.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})}L.current=k.length},[k]);let I=(0,l.useCallback)(async()=>{if((null==v?void 0:v.id)&&j)try{let e=await i.fb.getTicketDetails(j,v.id);N(e)}catch(e){console.error("Error loading ticket:",e)}},[null==v?void 0:v.id,j]),U=(0,l.useCallback)(async()=>{if((null==v?void 0:v.id)&&j)try{console.log("[Chat] Loading messages for ticket:",j);let e=await i.fb.getTicketMessages(j,v.id);_(e)}catch(e){console.error("Error loading messages:",e)}},[null==v?void 0:v.id,j]),V=(0,l.useCallback)(async()=>{try{R(!0),await Promise.all([I(),U()])}finally{R(!1)}},[I,U]);(0,c.sU)(j,I,U),(0,l.useEffect)(()=>{if(!(null==v?void 0:v.id)||!j)return;let e=setInterval(()=>{console.log("[Polling] Refreshing messages..."),U()},3e3);return()=>clearInterval(e)},[null==v?void 0:v.id,j,U]),(0,l.useEffect)(()=>{y||v?y||(null==v?void 0:v.role)==="agent"||(window.location.href="/tms/dashboard/".concat(null==v?void 0:v.role)):window.location.href="/tms"},[v,y]),(0,l.useEffect)(()=>{(null==v?void 0:v.id)&&j&&V()},[v,j,V]);let Z=async()=>{if(C.trim()&&!A)try{S(!0),await i.fb.addMessage(j,v.id,C),T(""),V()}catch(e){console.error("Error sending message:",e)}finally{S(!1)}},D=async e=>{try{await i.fb.updateTicketStatus(j,v.id,e),V()}catch(e){console.error("Error updating status:",e)}},q=async()=>{await D(5)};if(y||!v)return(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:"Loading..."});if(E)return(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:"Loading ticket..."});if(!w)return(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("p",{className:"text-gray-500 mb-4",children:"Ticket not found or you don't have access"}),(0,r.jsx)("button",{onClick:()=>window.history.back(),className:"text-green-600 hover:text-green-700",children:"Go back"})]})});let B=(null===(e=w.status)||void 0===e?void 0:e.name)||"Unknown",O=(null===(t=w.priority)||void 0===t?void 0:t.name)||"Medium",P=["Resolved","Closed"].includes(B);return(0,r.jsxs)("div",{className:"min-h-screen bg-gray-50 flex flex-col",children:[(0,r.jsx)("header",{className:"bg-green-600 text-white shrink-0",children:(0,r.jsxs)("div",{className:"max-w-5xl mx-auto px-4 py-4",children:[(0,r.jsxs)("button",{onClick:()=>window.history.back(),className:"flex items-center gap-2 text-green-200 hover:text-white mb-3",children:[(0,r.jsx)(u.Z,{className:"w-4 h-4"}),"Back to dashboard"]}),(0,r.jsxs)("div",{className:"flex items-start justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,r.jsxs)("span",{className:"text-sm text-green-200",children:["#",w.ticket_id]}),(0,r.jsx)("span",{className:"text-xs px-2 py-0.5 rounded-full ".concat(p[B]),children:B}),(0,r.jsx)("span",{className:"text-xs px-2 py-0.5 rounded-full ".concat(h[O]),children:O})]}),(0,r.jsx)("h1",{className:"text-xl font-bold",children:w.subject})]}),!P&&(0,r.jsxs)("button",{onClick:q,className:"flex items-center gap-2 bg-green-500 hover:bg-green-400 px-4 py-2 rounded-lg text-sm",children:[(0,r.jsx)(x.Z,{className:"w-4 h-4"}),"Mark Resolved"]})]})]})}),(0,r.jsx)("div",{className:"bg-white border-b border-gray-200 shrink-0",children:(0,r.jsxs)("div",{className:"max-w-5xl mx-auto px-4 py-4",children:[(0,r.jsxs)("div",{className:"grid grid-cols-4 gap-4 text-sm",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-gray-500",children:"Contact"}),(0,r.jsx)("p",{className:"font-medium",children:null===(s=w.contact)||void 0===s?void 0:s.full_name}),(0,r.jsx)("p",{className:"text-gray-400",children:null===(f=w.contact)||void 0===f?void 0:f.phone})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-gray-500",children:"Organization"}),(0,r.jsx)("p",{className:"font-medium",children:null===(b=w.organization)||void 0===b?void 0:b.name})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-gray-500",children:"Created"}),(0,r.jsx)("p",{className:"font-medium",children:(0,m.WU)(new Date(w.created_at),"MMM d, yyyy")}),(0,r.jsx)("p",{className:"text-gray-400",children:(0,g.Q)(new Date(w.created_at),{addSuffix:!0})})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-gray-500",children:"Update Status"}),(0,r.jsxs)("select",{value:w.status_id,onChange:e=>D(parseInt(e.target.value)),disabled:P,className:"mt-1 block w-full border border-gray-300 rounded-lg px-3 py-1.5 text-sm disabled:bg-gray-100",children:[(0,r.jsx)("option",{value:1,children:"Open"}),(0,r.jsx)("option",{value:2,children:"In Progress"}),(0,r.jsx)("option",{value:3,children:"Awaiting Customer"}),(0,r.jsx)("option",{value:4,children:"Escalated"}),(0,r.jsx)("option",{value:5,children:"Resolved"}),(0,r.jsx)("option",{value:6,children:"Closed"})]})]})]}),w.description&&(0,r.jsxs)("div",{className:"mt-4 pt-4 border-t border-gray-100",children:[(0,r.jsx)("p",{className:"text-gray-500 text-sm mb-1",children:"Description"}),(0,r.jsx)("p",{className:"text-gray-700",children:w.description})]})]})}),(0,r.jsx)("div",{className:"flex-1 overflow-auto bg-gray-50",children:(0,r.jsxs)("div",{className:"max-w-5xl mx-auto px-4 py-6",children:[(0,r.jsx)("h3",{className:"text-sm font-medium text-gray-500 mb-4",children:"Conversation"}),(0,r.jsx)(d.uU,{messages:k,currentUserId:v.id,userRole:"agent",messagesEndRef:M,emptyMessage:"No messages yet. Start the conversation below."})]})}),!P&&(0,r.jsx)("div",{className:"bg-white border-t border-gray-200 shrink-0 shadow-lg",children:(0,r.jsx)("div",{className:"max-w-5xl mx-auto px-4 py-4",children:(0,r.jsx)(d.xg,{value:C,onChange:T,onSend:Z,sending:A,placeholder:"Type your response...",accentColor:"green"})})}),P&&(0,r.jsx)("div",{className:"bg-gray-100 border-t border-gray-200 shrink-0",children:(0,r.jsxs)("div",{className:"max-w-5xl mx-auto px-4 py-4 text-center text-gray-500",children:["This ticket is ",B.toLowerCase(),"."]})})]})}},8729:function(e,t,s){"use strict";s.d(t,{uU:function(){return o},xg:function(){return d}});var r=s(7437),n=s(2222),a=s(2369),l=s(1817),i=s(2093);function c(e){var t,s,l;let{message:c,currentUserId:o,userRole:d}=e,u=!!c.sender_agent_id,x=u&&(null===(t=c.sender_agent)||void 0===t?void 0:t.agent_type)==="Bot",m="requester"===d?c.sender_contact_id===o:c.sender_agent_id===o,g=m?"You":u?(null===(l=c.sender_agent)||void 0===l?void 0:l.full_name)||"Support Agent":(null===(s=c.sender_contact)||void 0===s?void 0:s.full_name)||"Customer",h=()=>x?"text-purple-600":u?"text-green-600":"text-blue-600";return(0,r.jsxs)("div",{className:"flex gap-3 ".concat(m?"flex-row-reverse":""),children:[(0,r.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center shrink-0 shadow-sm ".concat(x?"bg-purple-100":u?"bg-green-100":"bg-blue-100"),children:x?(0,r.jsx)(n.Z,{className:"w-5 h-5 ".concat(h())}):(0,r.jsx)(a.Z,{className:"w-5 h-5 ".concat(h())})}),(0,r.jsxs)("div",{className:"flex flex-col max-w-[75%] ".concat(m?"items-end":"items-start"),children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-1 ".concat(m?"flex-row-reverse":""),children:[(0,r.jsx)("span",{className:"text-sm font-medium text-gray-700",children:g}),(0,r.jsx)("span",{className:"text-xs text-gray-400",children:(0,i.WU)(new Date(c.message_time),"MMM d, h:mm a")}),x&&(0,r.jsx)("span",{className:"text-xs bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded font-medium",children:"Bot"})]}),(0,r.jsx)("div",{className:"rounded-2xl px-4 py-2.5 shadow-sm ".concat(m?"requester"===d?"bg-blue-600 text-white":"agent"===d?"bg-green-600 text-white":"bg-purple-600 text-white":"bg-white border border-gray-200 text-gray-700"," ").concat(m?"rounded-tr-sm":"rounded-tl-sm"),children:(0,r.jsx)("div",{className:"whitespace-pre-wrap break-words leading-relaxed",children:x?function(e){let t=[],s=0;return e.split("\n").forEach((e,n)=>{let a;n>0&&t.push((0,r.jsx)("br",{},"br-".concat(s++)));let l=[],i=0,c=/\*\*(.+?)\*\*|__(.+?)__/g;for(;null!==(a=c.exec(e));){a.index>i&&l.push(e.substring(i,a.index));let t=a[1]||a[2];l.push((0,r.jsx)("strong",{className:"font-semibold",children:t},"bold-".concat(s++))),i=a.index+a[0].length}i<e.length&&l.push(e.substring(i)),0===l.length?t.push(e):t.push(...l)}),t}(c.content):c.content})})]})]})}function o(e){let{messages:t,currentUserId:s,userRole:i,messagesEndRef:o,emptyMessage:d="No messages yet. Start the conversation below.",aiThinking:u=!1}=e;return 0===t.length?(0,r.jsx)("div",{className:"flex items-center justify-center py-12",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,r.jsx)(a.Z,{className:"w-8 h-8 text-gray-400"})}),(0,r.jsx)("p",{className:"text-gray-500",children:d})]})}):(0,r.jsxs)("div",{className:"space-y-4",children:[t.map(e=>(0,r.jsx)(c,{message:e,currentUserId:s,userRole:i},e.message_id)),u&&(0,r.jsxs)("div",{className:"flex gap-3",children:[(0,r.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center shrink-0 shadow-sm bg-purple-100",children:(0,r.jsx)(n.Z,{className:"w-5 h-5 text-purple-600"})}),(0,r.jsxs)("div",{className:"flex flex-col items-start",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,r.jsx)("span",{className:"text-sm font-medium text-gray-700",children:"AI Assistant"}),(0,r.jsx)("span",{className:"text-xs bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded font-medium",children:"Bot"})]}),(0,r.jsx)("div",{className:"rounded-2xl rounded-tl-sm px-4 py-3 bg-white border border-gray-200 shadow-sm",children:(0,r.jsxs)("div",{className:"flex items-center gap-2 text-gray-500",children:[(0,r.jsx)(l.Z,{className:"w-4 h-4 animate-spin text-purple-600"}),(0,r.jsx)("span",{className:"text-sm",children:"AI is thinking..."})]})})]})]}),(0,r.jsx)("div",{ref:o})]})}function d(e){let{value:t,onChange:s,onSend:n,sending:a,placeholder:l="Type your message...",accentColor:i="blue"}=e,c={blue:{focus:"focus:ring-blue-500 focus:border-blue-500",button:"bg-blue-600 hover:bg-blue-700"},green:{focus:"focus:ring-green-500 focus:border-green-500",button:"bg-green-600 hover:bg-green-700"},purple:{focus:"focus:ring-purple-500 focus:border-purple-500",button:"bg-purple-600 hover:bg-purple-700"}}[i];return(0,r.jsxs)("div",{className:"flex gap-3 items-end",children:[(0,r.jsx)("div",{className:"flex-1 relative",children:(0,r.jsx)("textarea",{value:t,onChange:e=>s(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),n())},placeholder:l,rows:1,className:"w-full px-4 py-3 border border-gray-300 rounded-xl resize-none ".concat(c.focus," focus:ring-2 transition-shadow"),style:{minHeight:"48px",maxHeight:"120px"}})}),(0,r.jsx)("button",{onClick:n,disabled:!t.trim()||a,className:"p-3 ".concat(c.button," text-white rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm"),children:a?(0,r.jsx)("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}):(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})}},1939:function(e,t,s){"use strict";s.d(t,{r:function(){return n}});var r=s(2265);function n(e,t,s){let{playNotificationSound:n}=function(){let e=(0,r.useRef)(null),t=(0,r.useRef)(0);return(0,r.useEffect)(()=>{let t=()=>{e.current||(e.current=new(window.AudioContext||window.webkitAudioContext))};return document.addEventListener("click",t,{once:!0}),document.addEventListener("keypress",t,{once:!0}),()=>{document.removeEventListener("click",t),document.removeEventListener("keypress",t)}},[]),{playNotificationSound:(0,r.useCallback)(()=>{let s=Date.now();if(!(s-t.current<1e3)){t.current=s;try{e.current||(e.current=new(window.AudioContext||window.webkitAudioContext));let t=e.current;"suspended"===t.state&&t.resume();let s=t.createOscillator(),r=t.createGain();s.connect(r),r.connect(t.destination),s.frequency.setValueAtTime(880,t.currentTime),s.frequency.setValueAtTime(1047,t.currentTime+.1),s.type="sine",r.gain.setValueAtTime(0,t.currentTime),r.gain.linearRampToValueAtTime(.3,t.currentTime+.05),r.gain.linearRampToValueAtTime(.2,t.currentTime+.1),r.gain.linearRampToValueAtTime(.3,t.currentTime+.15),r.gain.linearRampToValueAtTime(0,t.currentTime+.3),s.start(t.currentTime),s.stop(t.currentTime+.3)}catch(e){console.log("[NotificationSound] Audio not available:",e)}}},[])}}(),a=(0,r.useRef)(0),l=(0,r.useRef)(new Set),i=(0,r.useRef)(!0);(0,r.useEffect)(()=>{if(!t||0===e.length)return;let r=new Set(e.map(e=>e.message_id));if(i.current){i.current=!1,a.current=e.length,l.current=r;return}let c=e.filter(e=>!l.current.has(e.message_id));c.length>0&&c.some(e=>"requester"===s?!!e.sender_agent_id:!!e.sender_contact_id)&&(console.log("[NotificationSound] New message from other party, playing sound"),n()),a.current=e.length,l.current=r},[e,t,s,n])}}},function(e){e.O(0,[539,602,152,971,117,744],function(){return e(e.s=8748)}),_N_E=e.O()}]);