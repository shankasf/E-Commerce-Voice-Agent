(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[87],{2673:function(e,t,s){Promise.resolve().then(s.bind(s,5037))},5037:function(e,t,s){"use strict";s.r(t),s.d(t,{default:function(){return j}});var r=s(7437),a=s(7766),n=s(9376),l=s(2265),i=s(1837),c=s(3552),o=s(1939),d=s(8729),u=s(2660),x=s(2222),m=s(9205);let g=(0,m.Z)("UserPlus",[["path",{d:"M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2",key:"1yyitq"}],["circle",{cx:"9",cy:"7",r:"4",key:"nufk8"}],["line",{x1:"19",x2:"19",y1:"8",y2:"14",key:"1bvyxn"}],["line",{x1:"22",x2:"16",y1:"11",y2:"11",key:"1shjgl"}]]),p=(0,m.Z)("Sparkles",[["path",{d:"M9.937 15.5A2 2 0 0 0 8.5 14.063l-6.135-1.582a.5.5 0 0 1 0-.962L8.5 9.936A2 2 0 0 0 9.937 8.5l1.582-6.135a.5.5 0 0 1 .963 0L14.063 8.5A2 2 0 0 0 15.5 9.937l6.135 1.581a.5.5 0 0 1 0 .964L15.5 14.063a2 2 0 0 0-1.437 1.437l-1.582 6.135a.5.5 0 0 1-.963 0z",key:"4pj2yx"}],["path",{d:"M20 3v4",key:"1olli1"}],["path",{d:"M22 5h-4",key:"1gvqau"}],["path",{d:"M4 17v2",key:"vumght"}],["path",{d:"M5 18H3",key:"zchphs"}]]);var h=s(2369),f=s(2093),b=s(5710);let y={Low:"bg-gray-100 text-gray-700",Medium:"bg-blue-100 text-blue-700",High:"bg-orange-100 text-orange-700",Critical:"bg-red-100 text-red-700"},v={Open:"bg-yellow-100 text-yellow-700","In Progress":"bg-blue-100 text-blue-700","Awaiting Customer":"bg-purple-100 text-purple-700",Escalated:"bg-orange-100 text-orange-700",Resolved:"bg-green-100 text-green-700",Closed:"bg-gray-100 text-gray-700"};function j(){var e,t,s,m,j,N;let{user:w,isLoading:k}=(0,a.a)(),_=parseInt((0,n.useParams)().id),[A,C]=(0,l.useState)(null),[S,T]=(0,l.useState)([]),[E,I]=(0,l.useState)([]),[M,R]=(0,l.useState)(!0),[D,L]=(0,l.useState)(!1),[z,B]=(0,l.useState)(null),[U,Z]=(0,l.useState)(!1),[H,P]=(0,l.useState)(!1),V=(0,l.useRef)(null),q=(0,l.useRef)(0);(0,o.r)(S,null==w?void 0:w.id,"admin"),(0,l.useEffect)(()=>{if(S.length>q.current){var e;null===(e=V.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})}q.current=S.length},[S]),(0,l.useEffect)(()=>{_&&i.Sb.getAIBotStatus(_).then(e=>{P(e.hasAIBot)})},[_,S]);let O=(0,l.useCallback)(async()=>{if(_)try{let e=await i.Sb.getTicketDetails(_);C(e)}catch(e){console.error("Error loading ticket:",e)}},[_]),G=(0,l.useCallback)(async()=>{if(_)try{console.log("[Chat] Loading messages for ticket:",_);let e=await i.Sb.getTicketMessages(_);T(e)}catch(e){console.error("Error loading messages:",e)}},[_]),W=(0,l.useCallback)(async()=>{try{R(!0);let[e,t,s]=await Promise.all([i.Sb.getTicketDetails(_),i.Sb.getTicketMessages(_),i.Sb.getAgents()]);C(e),T(t),I(s.filter(e=>"Human"===e.agent_type))}catch(e){console.error("Error loading ticket:",e)}finally{R(!1)}},[_]);(0,c.sU)(_,O,G),(0,l.useEffect)(()=>{if(!_)return;let e=setInterval(()=>{console.log("[Polling] Refreshing messages..."),G()},3e3);return()=>clearInterval(e)},[_,G]),(0,l.useEffect)(()=>{k||w?k||(null==w?void 0:w.role)==="admin"||(window.location.href="/tms/dashboard/".concat(null==w?void 0:w.role)):window.location.href="/tms"},[w,k]),(0,l.useEffect)(()=>{w&&_&&W()},[w,_,W]);let F=async e=>{try{await i.Sb.updateTicketStatus(_,e),W()}catch(e){console.error("Error updating status:",e)}},K=async()=>{if(z)try{await i.Sb.assignTicket(_,z),L(!1),B(null),W()}catch(e){console.error("Error assigning ticket:",e)}},Q=async()=>{Z(!0);try{let e=await i.Sb.assignAIBot(_);e.success?(P(!0),L(!1),W()):(console.error("Failed to assign AI bot:",e.error),alert("Failed to assign AI bot: "+e.error))}catch(e){console.error("Error assigning AI bot:",e)}finally{Z(!1)}};if(k||!w)return(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:"Loading..."});if(M)return(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:"Loading ticket..."});if(!A)return(0,r.jsx)("div",{className:"min-h-screen flex items-center justify-center",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("p",{className:"text-gray-500 mb-4",children:"Ticket not found"}),(0,r.jsx)("button",{onClick:()=>window.history.back(),className:"text-purple-600 hover:text-purple-700",children:"Go back"})]})});let Y=(null===(e=A.status)||void 0===e?void 0:e.name)||"Unknown",J=(null===(t=A.priority)||void 0===t?void 0:t.name)||"Medium";return(0,r.jsxs)("div",{className:"min-h-screen bg-gray-50 flex flex-col",children:[(0,r.jsx)("header",{className:"bg-purple-600 text-white shrink-0",children:(0,r.jsxs)("div",{className:"max-w-5xl mx-auto px-4 py-4",children:[(0,r.jsxs)("button",{onClick:()=>window.history.back(),className:"flex items-center gap-2 text-purple-200 hover:text-white mb-3",children:[(0,r.jsx)(u.Z,{className:"w-4 h-4"}),"Back to dashboard"]}),(0,r.jsxs)("div",{className:"flex items-start justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,r.jsxs)("span",{className:"text-sm text-purple-200",children:["#",A.ticket_id]}),(0,r.jsx)("span",{className:"text-xs px-2 py-0.5 rounded-full ".concat(v[Y]),children:Y}),(0,r.jsx)("span",{className:"text-xs px-2 py-0.5 rounded-full ".concat(y[J]),children:J}),H&&(0,r.jsxs)("span",{className:"text-xs px-2 py-0.5 rounded-full bg-purple-100 text-purple-700 flex items-center gap-1",children:[(0,r.jsx)(x.Z,{className:"w-3 h-3"}),"AI Bot Assigned"]})]}),(0,r.jsx)("h1",{className:"text-xl font-bold",children:A.subject})]}),(0,r.jsx)("div",{className:"flex gap-2",children:(0,r.jsxs)("button",{onClick:()=>L(!0),className:"flex items-center gap-2 bg-purple-500 hover:bg-purple-400 px-3 py-2 rounded-lg text-sm",children:[(0,r.jsx)(g,{className:"w-4 h-4"}),"Assign"]})})]})]})}),(0,r.jsx)("div",{className:"bg-white border-b border-gray-200 shrink-0",children:(0,r.jsxs)("div",{className:"max-w-5xl mx-auto px-4 py-4",children:[(0,r.jsxs)("div",{className:"grid grid-cols-4 gap-4 text-sm",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-gray-500",children:"Contact"}),(0,r.jsx)("p",{className:"font-medium",children:null===(s=A.contact)||void 0===s?void 0:s.full_name}),(0,r.jsx)("p",{className:"text-gray-400",children:null===(m=A.contact)||void 0===m?void 0:m.email})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-gray-500",children:"Organization"}),(0,r.jsx)("p",{className:"font-medium",children:null===(j=A.organization)||void 0===j?void 0:j.name}),(0,r.jsxs)("p",{className:"text-gray-400",children:["U&E: ",null===(N=A.organization)||void 0===N?void 0:N.u_e_code]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-gray-500",children:"Created"}),(0,r.jsx)("p",{className:"font-medium",children:(0,f.WU)(new Date(A.created_at),"MMM d, yyyy")}),(0,r.jsx)("p",{className:"text-gray-400",children:(0,b.Q)(new Date(A.created_at),{addSuffix:!0})})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("p",{className:"text-gray-500",children:"Status"}),(0,r.jsxs)("select",{value:A.status_id,onChange:e=>F(parseInt(e.target.value)),className:"mt-1 block w-full border border-gray-300 rounded-lg px-3 py-1.5 text-sm",children:[(0,r.jsx)("option",{value:1,children:"Open"}),(0,r.jsx)("option",{value:2,children:"In Progress"}),(0,r.jsx)("option",{value:3,children:"Awaiting Customer"}),(0,r.jsx)("option",{value:4,children:"Escalated"}),(0,r.jsx)("option",{value:5,children:"Resolved"}),(0,r.jsx)("option",{value:6,children:"Closed"})]})]})]}),A.description&&(0,r.jsxs)("div",{className:"mt-4 pt-4 border-t border-gray-100",children:[(0,r.jsx)("p",{className:"text-gray-500 text-sm mb-1",children:"Description"}),(0,r.jsx)("p",{className:"text-gray-700",children:A.description})]})]})}),(0,r.jsx)("div",{className:"flex-1 overflow-auto bg-gray-50",children:(0,r.jsxs)("div",{className:"max-w-5xl mx-auto px-4 py-6",children:[(0,r.jsx)("h3",{className:"text-sm font-medium text-gray-500 mb-4",children:"Conversation History"}),(0,r.jsx)(d.uU,{messages:S,currentUserId:w.id,userRole:"admin",messagesEndRef:V,emptyMessage:"No messages yet."})]})}),D&&(0,r.jsx)("div",{className:"fixed inset-0 bg-black/50 flex items-center justify-center z-50",children:(0,r.jsxs)("div",{className:"bg-white rounded-xl p-6 w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold mb-4",children:"Assign Ticket"}),(0,r.jsxs)("div",{className:"mb-4",children:[(0,r.jsx)("p",{className:"text-sm font-medium text-gray-600 mb-2",children:"\uD83E\uDD16 AI-Powered Resolution"}),(0,r.jsxs)("button",{onClick:Q,disabled:U||H,className:"w-full p-4 rounded-lg border text-left flex items-center gap-3 transition-all ".concat(H?"border-green-500 bg-green-50":"border-purple-300 bg-gradient-to-r from-purple-50 to-indigo-50 hover:border-purple-500"," disabled:opacity-50"),children:[(0,r.jsx)("div",{className:"w-12 h-12 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-full flex items-center justify-center",children:U?(0,r.jsx)("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}):(0,r.jsx)(p,{className:"w-6 h-6 text-white"})}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"font-semibold text-gray-900",children:H?"AI Bot Already Assigned":"Assign AI Support Bot"}),(0,r.jsx)("p",{className:"text-sm text-gray-500",children:H?"The AI bot is handling this ticket automatically":"Multi-agent AI will analyze and resolve the issue with step-by-step guidance"})]}),H&&(0,r.jsx)("span",{className:"text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full",children:"Active"})]}),(0,r.jsxs)("p",{className:"text-xs text-gray-400 mt-2 flex items-center gap-1",children:[(0,r.jsx)(p,{className:"w-3 h-3"}),"AI will auto-categorize, provide solutions, and close when resolved"]})]}),(0,r.jsx)("div",{className:"border-t border-gray-200 pt-4 mb-2",children:(0,r.jsx)("p",{className:"text-sm font-medium text-gray-600 mb-2",children:"\uD83D\uDC64 Human Agents"})}),(0,r.jsxs)("div",{className:"space-y-3 max-h-60 overflow-y-auto",children:[E.map(e=>(0,r.jsxs)("button",{onClick:()=>B(e.support_agent_id),className:"w-full p-3 rounded-lg border text-left flex items-center gap-3 ".concat(z===e.support_agent_id?"border-purple-500 bg-purple-50":"border-gray-200 hover:border-gray-300"),children:[(0,r.jsx)("div",{className:"w-10 h-10 bg-green-100 rounded-full flex items-center justify-center",children:(0,r.jsx)(h.Z,{className:"w-5 h-5 text-green-600"})}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsx)("p",{className:"font-medium text-gray-900",children:e.full_name}),(0,r.jsx)("p",{className:"text-sm text-gray-500",children:e.specialization||"General Support"})]}),e.is_available&&(0,r.jsx)("span",{className:"text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full",children:"Available"})]},e.support_agent_id)),0===E.length&&(0,r.jsx)("p",{className:"text-sm text-gray-400 text-center py-4",children:"No human agents available"})]}),(0,r.jsxs)("div",{className:"flex justify-end gap-3 mt-6 pt-4 border-t border-gray-200",children:[(0,r.jsx)("button",{onClick:()=>{L(!1),B(null)},className:"px-4 py-2 text-gray-600 hover:text-gray-900",children:"Cancel"}),(0,r.jsx)("button",{onClick:K,disabled:!z,className:"px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:opacity-50",children:"Assign Human"})]})]})})]})}},8729:function(e,t,s){"use strict";s.d(t,{uU:function(){return o},xg:function(){return d}});var r=s(7437),a=s(2222),n=s(2369),l=s(1817),i=s(2093);function c(e){var t,s,l;let{message:c,currentUserId:o,userRole:d}=e,u=!!c.sender_agent_id,x=u&&(null===(t=c.sender_agent)||void 0===t?void 0:t.agent_type)==="Bot",m="requester"===d?c.sender_contact_id===o:c.sender_agent_id===o,g=m?"You":u?(null===(l=c.sender_agent)||void 0===l?void 0:l.full_name)||"Support Agent":(null===(s=c.sender_contact)||void 0===s?void 0:s.full_name)||"Customer",p=()=>x?"text-purple-600":u?"text-green-600":"text-blue-600";return(0,r.jsxs)("div",{className:"flex gap-3 ".concat(m?"flex-row-reverse":""),children:[(0,r.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center shrink-0 shadow-sm ".concat(x?"bg-purple-100":u?"bg-green-100":"bg-blue-100"),children:x?(0,r.jsx)(a.Z,{className:"w-5 h-5 ".concat(p())}):(0,r.jsx)(n.Z,{className:"w-5 h-5 ".concat(p())})}),(0,r.jsxs)("div",{className:"flex flex-col max-w-[75%] ".concat(m?"items-end":"items-start"),children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-1 ".concat(m?"flex-row-reverse":""),children:[(0,r.jsx)("span",{className:"text-sm font-medium text-gray-700",children:g}),(0,r.jsx)("span",{className:"text-xs text-gray-400",children:(0,i.WU)(new Date(c.message_time),"MMM d, h:mm a")}),x&&(0,r.jsx)("span",{className:"text-xs bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded font-medium",children:"Bot"})]}),(0,r.jsx)("div",{className:"rounded-2xl px-4 py-2.5 shadow-sm ".concat(m?"requester"===d?"bg-blue-600 text-white":"agent"===d?"bg-green-600 text-white":"bg-purple-600 text-white":"bg-white border border-gray-200 text-gray-700"," ").concat(m?"rounded-tr-sm":"rounded-tl-sm"),children:(0,r.jsx)("div",{className:"whitespace-pre-wrap break-words leading-relaxed",children:x?function(e){let t=[],s=0;return e.split("\n").forEach((e,a)=>{let n;a>0&&t.push((0,r.jsx)("br",{},"br-".concat(s++)));let l=[],i=0,c=/\*\*(.+?)\*\*|__(.+?)__/g;for(;null!==(n=c.exec(e));){n.index>i&&l.push(e.substring(i,n.index));let t=n[1]||n[2];l.push((0,r.jsx)("strong",{className:"font-semibold",children:t},"bold-".concat(s++))),i=n.index+n[0].length}i<e.length&&l.push(e.substring(i)),0===l.length?t.push(e):t.push(...l)}),t}(c.content):c.content})})]})]})}function o(e){let{messages:t,currentUserId:s,userRole:i,messagesEndRef:o,emptyMessage:d="No messages yet. Start the conversation below.",aiThinking:u=!1}=e;return 0===t.length?(0,r.jsx)("div",{className:"flex items-center justify-center py-12",children:(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4",children:(0,r.jsx)(n.Z,{className:"w-8 h-8 text-gray-400"})}),(0,r.jsx)("p",{className:"text-gray-500",children:d})]})}):(0,r.jsxs)("div",{className:"space-y-4",children:[t.map(e=>(0,r.jsx)(c,{message:e,currentUserId:s,userRole:i},e.message_id)),u&&(0,r.jsxs)("div",{className:"flex gap-3",children:[(0,r.jsx)("div",{className:"w-10 h-10 rounded-full flex items-center justify-center shrink-0 shadow-sm bg-purple-100",children:(0,r.jsx)(a.Z,{className:"w-5 h-5 text-purple-600"})}),(0,r.jsxs)("div",{className:"flex flex-col items-start",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,r.jsx)("span",{className:"text-sm font-medium text-gray-700",children:"AI Assistant"}),(0,r.jsx)("span",{className:"text-xs bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded font-medium",children:"Bot"})]}),(0,r.jsx)("div",{className:"rounded-2xl rounded-tl-sm px-4 py-3 bg-white border border-gray-200 shadow-sm",children:(0,r.jsxs)("div",{className:"flex items-center gap-2 text-gray-500",children:[(0,r.jsx)(l.Z,{className:"w-4 h-4 animate-spin text-purple-600"}),(0,r.jsx)("span",{className:"text-sm",children:"AI is thinking..."})]})})]})]}),(0,r.jsx)("div",{ref:o})]})}function d(e){let{value:t,onChange:s,onSend:a,sending:n,placeholder:l="Type your message...",accentColor:i="blue"}=e,c={blue:{focus:"focus:ring-blue-500 focus:border-blue-500",button:"bg-blue-600 hover:bg-blue-700"},green:{focus:"focus:ring-green-500 focus:border-green-500",button:"bg-green-600 hover:bg-green-700"},purple:{focus:"focus:ring-purple-500 focus:border-purple-500",button:"bg-purple-600 hover:bg-purple-700"}}[i];return(0,r.jsxs)("div",{className:"flex gap-3 items-end",children:[(0,r.jsx)("div",{className:"flex-1 relative",children:(0,r.jsx)("textarea",{value:t,onChange:e=>s(e.target.value),onKeyDown:e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),a())},placeholder:l,rows:1,className:"w-full px-4 py-3 border border-gray-300 rounded-xl resize-none ".concat(c.focus," focus:ring-2 transition-shadow"),style:{minHeight:"48px",maxHeight:"120px"}})}),(0,r.jsx)("button",{onClick:a,disabled:!t.trim()||n,className:"p-3 ".concat(c.button," text-white rounded-xl disabled:opacity-50 disabled:cursor-not-allowed transition-colors shadow-sm"),children:n?(0,r.jsx)("div",{className:"w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"}):(0,r.jsx)("svg",{className:"w-5 h-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:(0,r.jsx)("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M12 19l9 2-9-18-9 18 9-2zm0 0v-8"})})})]})}},1939:function(e,t,s){"use strict";s.d(t,{r:function(){return a}});var r=s(2265);function a(e,t,s){let{playNotificationSound:a}=function(){let e=(0,r.useRef)(null),t=(0,r.useRef)(0);return(0,r.useEffect)(()=>{let t=()=>{e.current||(e.current=new(window.AudioContext||window.webkitAudioContext))};return document.addEventListener("click",t,{once:!0}),document.addEventListener("keypress",t,{once:!0}),()=>{document.removeEventListener("click",t),document.removeEventListener("keypress",t)}},[]),{playNotificationSound:(0,r.useCallback)(()=>{let s=Date.now();if(!(s-t.current<1e3)){t.current=s;try{e.current||(e.current=new(window.AudioContext||window.webkitAudioContext));let t=e.current;"suspended"===t.state&&t.resume();let s=t.createOscillator(),r=t.createGain();s.connect(r),r.connect(t.destination),s.frequency.setValueAtTime(880,t.currentTime),s.frequency.setValueAtTime(1047,t.currentTime+.1),s.type="sine",r.gain.setValueAtTime(0,t.currentTime),r.gain.linearRampToValueAtTime(.3,t.currentTime+.05),r.gain.linearRampToValueAtTime(.2,t.currentTime+.1),r.gain.linearRampToValueAtTime(.3,t.currentTime+.15),r.gain.linearRampToValueAtTime(0,t.currentTime+.3),s.start(t.currentTime),s.stop(t.currentTime+.3)}catch(e){console.log("[NotificationSound] Audio not available:",e)}}},[])}}(),n=(0,r.useRef)(0),l=(0,r.useRef)(new Set),i=(0,r.useRef)(!0);(0,r.useEffect)(()=>{if(!t||0===e.length)return;let r=new Set(e.map(e=>e.message_id));if(i.current){i.current=!1,n.current=e.length,l.current=r;return}let c=e.filter(e=>!l.current.has(e.message_id));c.length>0&&c.some(e=>"requester"===s?!!e.sender_agent_id:!!e.sender_contact_id)&&(console.log("[NotificationSound] New message from other party, playing sound"),a()),n.current=e.length,l.current=r},[e,t,s,a])}}},function(e){e.O(0,[539,602,152,971,117,744],function(){return e(e.s=2673)}),_N_E=e.O()}]);