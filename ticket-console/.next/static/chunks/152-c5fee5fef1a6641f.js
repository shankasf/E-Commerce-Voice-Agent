"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[152],{1837:function(t,e,n){n.d(e,{Sb:function(){return r},UD:function(){return a},fb:function(){return s}});var i=n(5526);let a={async getMyTickets(t){let{data:e,error:n}=await i.O.from("support_tickets").select("\n        *,\n        status:status_id(name),\n        priority:priority_id(name),\n        organization:organization_id(name)\n      ").eq("contact_id",t).order("created_at",{ascending:!1});if(n)throw n;return e||[]},async getTicketDetails(t,e){let{data:n,error:a}=await i.O.from("support_tickets").select("\n        *,\n        status:status_id(name),\n        priority:priority_id(name),\n        organization:organization_id(name),\n        contact:contact_id(full_name, email, phone)\n      ").eq("ticket_id",t).eq("contact_id",e).single();return a?null:n},async getTicketMessages(t,e){if(!await this.getTicketDetails(t,e))return[];let{data:n,error:a}=await i.O.from("ticket_messages").select("\n        *,\n        sender_agent:sender_agent_id(full_name, agent_type),\n        sender_contact:sender_contact_id(full_name)\n      ").eq("ticket_id",t).order("message_time",{ascending:!0});if(a)throw a;return n||[]},async createTicket(t,e,n,a){let r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:2,{data:s,error:o}=await i.O.from("support_tickets").insert({contact_id:t,organization_id:e,subject:n,description:a,status_id:1,priority_id:r,requires_human_agent:!1}).select().single();if(o)throw o;return s&&fetch("/tms/api/ai-resolve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"assign",ticketId:s.ticket_id})}).catch(t=>console.log("AI bot auto-assignment failed:",t)),s},async addMessage(t,e,n){if(!await this.getTicketDetails(t,e))return null;let{data:a,error:r}=await i.O.from("ticket_messages").insert({ticket_id:t,sender_contact_id:e,content:n,message_type:"text"}).select().single();if(r)throw r;return fetch("/tms/api/ai-resolve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"respond",ticketId:t,userMessage:n})}).catch(t=>console.log("AI bot response not triggered:",t)),a},async getMyProfile(t){let{data:e,error:n}=await i.O.from("contacts").select("*, organization:organization_id(name, u_e_code)").eq("contact_id",t).single();return n?null:e}},r={async getAllTickets(t){let e=i.O.from("support_tickets").select("\n        *,\n        status:status_id(name),\n        priority:priority_id(name),\n        organization:organization_id(name),\n        contact:contact_id(full_name, phone)\n      ").order("created_at",{ascending:!1});(null==t?void 0:t.statusId)&&(e=e.eq("status_id",t.statusId)),(null==t?void 0:t.priorityId)&&(e=e.eq("priority_id",t.priorityId)),(null==t?void 0:t.organizationId)&&(e=e.eq("organization_id",t.organizationId));let{data:n,error:a}=await e;if(a)throw a;return n||[]},async getTicketDetails(t){let{data:e,error:n}=await i.O.from("support_tickets").select("\n        *,\n        status:status_id(name),\n        priority:priority_id(name),\n        organization:organization_id(name, u_e_code),\n        contact:contact_id(full_name, email, phone)\n      ").eq("ticket_id",t).single();return n?null:e},async getTicketMessages(t){let{data:e,error:n}=await i.O.from("ticket_messages").select("\n        *,\n        sender_agent:sender_agent_id(full_name, agent_type),\n        sender_contact:sender_contact_id(full_name)\n      ").eq("ticket_id",t).order("message_time",{ascending:!0});if(n)throw n;return e||[]},async getOrganizations(){let{data:t,error:e}=await i.O.from("organizations").select("*").order("name");if(e)throw e;return t||[]},async getContacts(t){let e=i.O.from("contacts").select("*, organization:organization_id(name)").order("full_name");t&&(e=e.eq("organization_id",t));let{data:n,error:a}=await e;if(a)throw a;return n||[]},async getAgents(){let{data:t,error:e}=await i.O.from("support_agents").select("*").order("full_name");if(e)throw e;return t||[]},async createOrganization(t,e){let{data:n,error:a}=await i.O.from("organizations").insert({name:t,u_e_code:e}).select().single();if(a)throw a;return n},async createContact(t,e,n,a){let{data:r,error:s}=await i.O.from("contacts").insert({full_name:t,email:e,phone:n,organization_id:a}).select().single();if(s)throw s;return r},async createAgent(t,e,n,a){let{data:r,error:s}=await i.O.from("support_agents").insert({full_name:t,email:e,agent_type:n,specialization:a,is_available:!0}).select().single();if(s)throw s;return r},async updateTicketStatus(t,e){let n={status_id:e,updated_at:new Date().toISOString()};e>=5&&(n.closed_at=new Date().toISOString());let{error:a}=await i.O.from("support_tickets").update(n).eq("ticket_id",t);return!a},async assignTicket(t,e){let n=!(arguments.length>2)||void 0===arguments[2]||arguments[2],{error:a}=await i.O.from("ticket_assignments").insert({ticket_id:t,support_agent_id:e,is_primary:n});return a||await this.updateTicketStatus(t,2),!a},async assignAIBot(t){try{let e=await fetch("/tms/api/ai-resolve",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"assign",ticketId:t})});if(!e.ok){let t=await e.json();return{success:!1,error:t.message||"Failed to assign AI bot"}}let n=await e.json();return{success:!0,category:n.category}}catch(t){return{success:!1,error:"Network error"}}},async getAIBotStatus(t){try{let e=await fetch("/tms/api/ai-resolve?ticketId=".concat(t));if(!e.ok)return{hasAIBot:!1};return await e.json()}catch(t){return{hasAIBot:!1}}},async getDashboardStats(){let[t,e,n,a]=await Promise.all([i.O.from("support_tickets").select("status_id, priority_id"),i.O.from("organizations").select("organization_id"),i.O.from("contacts").select("contact_id"),i.O.from("support_agents").select("support_agent_id, is_available").eq("agent_type","Human")]),r=t.data||[];return{totalTickets:r.length,openTickets:r.filter(t=>1===t.status_id).length,inProgressTickets:r.filter(t=>2===t.status_id).length,escalatedTickets:r.filter(t=>4===t.status_id).length,criticalTickets:r.filter(t=>4===t.priority_id).length,totalOrganizations:(e.data||[]).length,totalContacts:(n.data||[]).length,totalAgents:(a.data||[]).length,availableAgents:(a.data||[]).filter(t=>t.is_available).length}}},s={async getAssignedTickets(t){let{data:e,error:n}=await i.O.from("ticket_assignments").select("ticket_id").eq("support_agent_id",t);if(n||!(null==e?void 0:e.length))return this.getEscalatedTickets();let a=e.map(t=>t.ticket_id),{data:r,error:s}=await i.O.from("support_tickets").select("\n        *,\n        status:status_id(name),\n        priority:priority_id(name),\n        organization:organization_id(name),\n        contact:contact_id(full_name, phone)\n      ").in("ticket_id",a).order("priority_id",{ascending:!1}).order("created_at",{ascending:!1});if(s)throw s;return r||[]},async getEscalatedTickets(){let{data:t,error:e}=await i.O.from("support_tickets").select("\n        *,\n        status:status_id(name),\n        priority:priority_id(name),\n        organization:organization_id(name),\n        contact:contact_id(full_name, phone)\n      ").eq("status_id",4).order("priority_id",{ascending:!1}).order("created_at",{ascending:!1});if(e)throw e;return t||[]},async getHumanRequiredTickets(){let{data:t,error:e}=await i.O.from("support_tickets").select("\n        *,\n        status:status_id(name),\n        priority:priority_id(name),\n        organization:organization_id(name),\n        contact:contact_id(full_name, phone)\n      ").eq("requires_human_agent",!0).in("status_id",[1,2,3,4]).order("priority_id",{ascending:!1}).order("created_at",{ascending:!1});if(e)throw e;return t||[]},async getTicketDetails(t,e){console.log("getTicketDetails called with ticketId:",t,"agentId:",e);let{data:n,error:a}=await i.O.from("support_tickets").select("\n        *,\n        status:status_id(name),\n        priority:priority_id(name),\n        organization:organization_id(name, u_e_code),\n        contact:contact_id(full_name, email, phone)\n      ").eq("ticket_id",t).single();if(a)return console.error("Error fetching ticket:",a),null;if(console.log("Ticket data:",n),4===n.status_id||n.requires_human_agent)return console.log("Ticket is escalated or requires human - granting access"),n;let{data:r,error:s}=await i.O.from("ticket_assignments").select("assignment_id").eq("ticket_id",t).eq("support_agent_id",e).single();return(console.log("Assignment check:",{assignment:r,assignError:s,ticketId:t,agentId:e}),r)?console.log("Agent is assigned - granting access"):console.log("No specific access found, but granting access for demo"),n},async getTicketMessages(t,e){if(!await this.getTicketDetails(t,e))return[];let{data:n,error:a}=await i.O.from("ticket_messages").select("\n        *,\n        sender_agent:sender_agent_id(full_name, agent_type),\n        sender_contact:sender_contact_id(full_name)\n      ").eq("ticket_id",t).order("message_time",{ascending:!0});if(a)throw a;return n||[]},async addMessage(t,e,n){if(!await this.getTicketDetails(t,e))return null;let{data:a,error:r}=await i.O.from("ticket_messages").insert({ticket_id:t,sender_agent_id:e,content:n,message_type:"text"}).select().single();if(r)throw r;return a},async updateTicketStatus(t,e,n){if(!await this.getTicketDetails(t,e))return!1;let a={status_id:n,updated_at:new Date().toISOString()};n>=5&&(a.closed_at=new Date().toISOString());let{error:r}=await i.O.from("support_tickets").update(a).eq("ticket_id",t);return!r},async claimTicket(t,e){let{error:n}=await i.O.from("ticket_assignments").insert({ticket_id:t,support_agent_id:e,is_primary:!0});return n||await this.updateTicketStatus(t,e,2),!n},async getMyProfile(t){let{data:e,error:n}=await i.O.from("support_agents").select("*").eq("support_agent_id",t).single();return n?null:e},async updateAvailability(t,e){let{error:n}=await i.O.from("support_agents").update({is_available:e}).eq("support_agent_id",t);return!n},async getDashboardStats(t){let e=await this.getAssignedTickets(t),n=await this.getEscalatedTickets(),i=await this.getHumanRequiredTickets();return{assignedTickets:e.length,escalatedTickets:n.length,humanRequiredTickets:i.length,criticalTickets:[...e,...n].filter(t=>4===t.priority_id).length}}}},7766:function(t,e,n){n.d(e,{H:function(){return o},a:function(){return c}});var i=n(7437),a=n(2265);let r=(0,a.createContext)({user:null,login:()=>{},logout:()=>{},isLoading:!0}),s={requester:{role:"requester",id:1,name:"John Smith",email:"john.smith@acmecorp.com",organization_id:1},admin:{role:"admin",id:100,name:"Admin User",email:"admin@urackit.com"},agent:{role:"agent",id:2,name:"Alex Support",email:"alex@urackit.com"}};function o(t){let{children:e}=t,[n,o]=(0,a.useState)(null),[c,l]=(0,a.useState)(!0),[u,d]=(0,a.useState)(!1);return((0,a.useEffect)(()=>{d(!0);{let t=localStorage.getItem("urackit_user");if(t)try{o(JSON.parse(t))}catch(t){localStorage.removeItem("urackit_user")}}l(!1)},[]),u)?(0,i.jsx)(r.Provider,{value:{user:n,login:t=>{let e=s[t];o(e),localStorage.setItem("urackit_user",JSON.stringify(e))},logout:()=>{o(null),localStorage.removeItem("urackit_user")},isLoading:c},children:e}):(0,i.jsx)(i.Fragment,{children:e})}function c(){return(0,a.useContext)(r)}},5526:function(t,e,n){let i;n.d(e,{O:function(){return i}});var a=n(3053);let r="https://wwdzxovkandfyohsfybm.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3ZHp4b3ZrYW5kZnlvaHNmeWJtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NTc3MjQyNiwiZXhwIjoyMDgxMzQ4NDI2fQ.D0dqV0ViOyv1xiNGqhzXlfz6TaCaDHibgkTGlSBVxIk";i=r&&s?(0,a.eI)(r,s,{auth:{autoRefreshToken:!1,persistSession:!1}}):(0,a.eI)("https://placeholder.supabase.co","placeholder-key")},3552:function(t,e,n){n.d(e,{im:function(){return c},Po:function(){return l},sU:function(){return o}});var i=n(2265),a=n(5526);let r=new Map;function s(t,e){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],{table:s,event:o="*",filter:c,enabled:l=!0}=t,u=(0,i.useRef)(e);(0,i.useEffect)(()=>{u.current=e},[e]),(0,i.useEffect)(()=>{if(l)return function(t){let{table:e,event:n="*",filter:i,onData:s}=t,o=function(t,e){let n=Math.random().toString(36).substring(7);return e?"".concat(t,"-").concat(e,"-").concat(n):"".concat(t,"-").concat(n)}(e,i);console.log("[Realtime] Subscribing to ".concat(e).concat(i?" with filter ".concat(i):""));let c=a.O.channel(o).on("postgres_changes",{event:n,schema:"public",table:e,...i?{filter:i}:{}},t=>{console.log("[Realtime] Event received on ".concat(e,":"),t.eventType,t),s(t)}).subscribe(t=>{console.log("[Realtime] Channel ".concat(o," status:"),t),"SUBSCRIBED"===t?console.log("[Realtime] ✓ Successfully subscribed to ".concat(o)):"CLOSED"===t||"CHANNEL_ERROR"===t?console.error("[Realtime] ✗ Channel ".concat(o," closed or error")):"TIMED_OUT"===t&&console.error("[Realtime] ✗ Channel ".concat(o," timed out"))});return r.set(o,c),()=>{console.log("[Realtime] Unsubscribing from ".concat(o)),a.O.removeChannel(c),r.delete(o)}}({table:s,event:o,filter:c,onData:t=>u.current(t)})},[s,o,c,l,...n])}function o(t,e,n){let a=(0,i.useRef)(e),r=(0,i.useRef)(n);(0,i.useEffect)(()=>{a.current=e,r.current=n},[e,n]),s({table:"support_tickets",filter:t?"ticket_id=eq.".concat(t):void 0,enabled:!!t},()=>a.current(),[t]),s({table:"ticket_messages",filter:t?"ticket_id=eq.".concat(t):void 0,enabled:!!t},()=>r.current(),[t])}function c(t){let e=(0,i.useRef)(t);(0,i.useEffect)(()=>{e.current=t},[t]),s({table:"support_tickets"},()=>e.current(),[]),s({table:"ticket_assignments"},()=>e.current(),[])}function l(t,e){let n=(0,i.useRef)(e);(0,i.useEffect)(()=>{n.current=e},[e]),s({table:"support_tickets",filter:t?"contact_id=eq.".concat(t):void 0,enabled:!!t},()=>n.current(),[t])}}}]);