"use strict";(()=>{var e={};e.id=723,e.ids=[723],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},4213:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>g,patchFetch:()=>f,requestAsyncStorage:()=>l,routeModule:()=>p,serverHooks:()=>h,staticGenerationAsyncStorage:()=>_});var i={};a.r(i),a.d(i,{GET:()=>c,dynamic:()=>u});var n=a(9303),r=a(8716),s=a(670),o=a(7070),d=a(7857);let u="force-dynamic",m=(0,d.eI)("https://wwdzxovkandfyohsfybm.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind3ZHp4b3ZrYW5kZnlvaHNmeWJtIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NTc3MjQyNiwiZXhwIjoyMDgxMzQ4NDI2fQ.D0dqV0ViOyv1xiNGqhzXlfz6TaCaDHibgkTGlSBVxIk");async function c(e){try{let{data:e,error:t}=await m.from("support_tickets").select(`
        ticket_id,
        subject,
        status_id,
        priority_id,
        requires_human_agent,
        created_at,
        closed_at,
        organization:organization_id(name)
      `);if(t)throw t;let{data:a,error:i}=await m.from("ticket_assignments").select(`
        ticket_id,
        support_agent:support_agent_id(support_agent_id, full_name, agent_type)
      `);if(i)throw i;let{data:n,error:r}=await m.from("ticket_messages").select(`
        message_id,
        ticket_id,
        message_time,
        sender_agent_id,
        sender_contact_id,
        sender_agent:sender_agent_id(agent_type)
      `).order("message_time",{ascending:!0});if(r)throw r;let{data:s,error:d}=await m.from("organizations").select("organization_id, name");if(d)throw d;let u=e||[],c={};(a||[]).forEach(e=>{c[e.ticket_id]||(c[e.ticket_id]=[]),c[e.ticket_id].push(e)});let p={};(n||[]).forEach(e=>{p[e.ticket_id]||(p[e.ticket_id]=[]),p[e.ticket_id].push(e)});let l=u.length,_=0,h=0,g=0,f=0,y=0,I=0,k=0,w=0,x={};(s||[]).forEach(e=>{x[e.organization_id]={ai:0,human:0,name:e.name}});let z={},M=new Date;for(let e=29;e>=0;e--){let t=new Date(M);t.setDate(t.getDate()-e),z[t.toISOString().split("T")[0]]={ai:0,human:0}}let v={1:{ai:0,human:0},2:{ai:0,human:0},3:{ai:0,human:0},4:{ai:0,human:0}};u.forEach(e=>{let t=e.ticket_id,a=c[t]||[],i=p[t]||[],n=5===e.status_id||6===e.status_id,r=e.organization?.organization_id||e.organization_id,s=a.some(e=>e.support_agent?.agent_type==="Bot"),o=a.some(e=>e.support_agent?.agent_type==="Human"),d=e.requires_human_agent,u=i.filter(e=>e.sender_agent?.agent_type==="Bot"),m=i.filter(e=>e.sender_agent?.agent_type==="Human");y+=u.length,I+=m.length;let l=null;if(i.forEach(e=>{let t=new Date(e.message_time);if(e.sender_contact_id)l=t;else if(l&&e.sender_agent_id){let a=t.getTime()-l.getTime();e.sender_agent?.agent_type==="Bot"?k+=a:e.sender_agent?.agent_type==="Human"&&(w+=a),l=null}}),n){let t=e.closed_at?new Date(e.closed_at).toISOString().split("T")[0]:null;d||o?(h++,t&&z[t]&&z[t].human++,r&&x[r]&&x[r].human++,v[e.priority_id]&&v[e.priority_id].human++):s&&u.length>0&&(_++,t&&z[t]&&z[t].ai++,r&&x[r]&&x[r].ai++,v[e.priority_id]&&v[e.priority_id].ai++)}else f++;d&&s&&g++});let b=y>0?Math.round(k/y/1e3):8,j=I>0?Math.round(w/I/1e3/60):45,S=Math.round(45*_/60),T=_+h,C=T>0?Math.round(_/T*100):0,D=Object.values(x).filter(e=>e.ai>0||e.human>0).map(e=>({name:e.name.length>15?e.name.substring(0,15)+"...":e.name,ai:e.ai,human:e.human,aiPercentage:e.ai+e.human>0?Math.round(e.ai/(e.ai+e.human)*100):0})).sort((e,t)=>t.ai+t.human-(e.ai+e.human)).slice(0,10),O=Object.entries(z).map(([e,t])=>({date:e.slice(5),ai:t.ai,human:t.human})),N={1:"Low",2:"Medium",3:"High",4:"Critical"},Z=Object.entries(v).map(([e,t])=>({priority:N[parseInt(e)],ai:t.ai,human:t.human}));return o.NextResponse.json({summary:{totalTickets:l,resolvedByAI:_,resolvedByHuman:h,escalatedToHuman:g,pendingTickets:f,aiResolutionRate:C,timeSavedByAI:S,costSavedByAI:25*S,avgAIResponseTime:b,avgHumanResponseTime:j,aiMessagesCount:y,humanMessagesCount:I},charts:{dailyTrend:O,orgPreference:D,priorityBreakdown:Z,firstResponseComparison:{ai:b,human:60*j}}})}catch(e){return console.error("Error fetching AI metrics:",e),o.NextResponse.json({error:"Failed to fetch metrics"},{status:500})}}let p=new n.AppRouteRouteModule({definition:{kind:r.x.APP_ROUTE,page:"/api/ai-metrics/route",pathname:"/api/ai-metrics",filename:"route",bundlePath:"app/api/ai-metrics/route"},resolvedPagePath:"/root/webhook/ticket-console/src/app/api/ai-metrics/route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:l,staticGenerationAsyncStorage:_,serverHooks:h}=p,g="/api/ai-metrics/route";function f(){return(0,s.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:_})}}};var t=require("../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),i=t.X(0,[276,564],()=>a(4213));module.exports=i})();