generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== Users & Authentication ====================

model User {
  id          Int       @id @default(autoincrement())
  googleId    String    @unique @db.VarChar(255)
  email       String    @unique @db.VarChar(255)
  fullName    String    @db.VarChar(255)
  avatarUrl   String?   @db.VarChar(500)
  role        UserRole  @default(viewer)
  isActive    Boolean   @default(true)
  lastLoginAt DateTime? @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @db.Timestamptz(6)

  // Relations
  auditLogs           AuditLog[]
  alertConfigurations AlertConfiguration[]
  savedLogFilters     SavedLogFilter[]
  deploymentHistory   DeploymentHistory[]

  @@index([email])
  @@index([googleId])
  @@map("users")
}

enum UserRole {
  admin
  operator
  viewer
}

// ==================== Audit Logging ====================

model AuditLog {
  id           Int      @id @default(autoincrement())
  userId       Int
  user         User     @relation(fields: [userId], references: [id])
  action       String   @db.VarChar(100) // e.g., "pod.restart", "deployment.scale"
  resource     String   @db.VarChar(100) // e.g., "pod", "deployment", "secret"
  resourceName String   @db.VarChar(255) // e.g., "urackit-backend"
  namespace    String   @db.VarChar(100) // e.g., "urackit-v2"
  details      Json? // Additional context
  ipAddress    String?  @db.VarChar(45)
  userAgent    String?  @db.VarChar(500)
  status       String   @default("success") @db.VarChar(20) // success, failed
  errorMessage String?  @db.Text
  createdAt    DateTime @default(now()) @db.Timestamptz(6)

  @@index([userId])
  @@index([action])
  @@index([namespace])
  @@index([createdAt])
  @@map("audit_logs")
}

// ==================== Deployment History (for rollback) ====================

model DeploymentHistory {
  id             Int      @id @default(autoincrement())
  deploymentName String   @db.VarChar(255)
  namespace      String   @db.VarChar(100)
  revision       Int
  image          String   @db.VarChar(500)
  replicas       Int
  configSnapshot Json // Full deployment spec snapshot
  triggeredById  Int?
  triggeredBy    User?    @relation(fields: [triggeredById], references: [id])
  status         String   @db.VarChar(50) // deployed, rolled_back, failed
  rollbackOf     Int? // References another history entry if rollback
  createdAt      DateTime @default(now()) @db.Timestamptz(6)

  @@index([deploymentName, namespace])
  @@index([createdAt])
  @@map("deployment_history")
}

// ==================== Alert Configurations ====================

model AlertConfiguration {
  id           Int       @id @default(autoincrement())
  name         String    @db.VarChar(255)
  namespace    String?   @db.VarChar(100) // null = all namespaces
  alertType    AlertType
  threshold    Decimal   @db.Decimal(10, 2)
  comparison   String    @db.VarChar(10) // >, <, >=, <=, ==
  enabled      Boolean   @default(true)
  notifyEmail  Boolean   @default(true)
  notifySlack  Boolean   @default(false)
  slackWebhook String?   @db.VarChar(500)
  createdById  Int
  createdBy    User      @relation(fields: [createdById], references: [id])
  createdAt    DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @db.Timestamptz(6)

  // Relations
  alerts Alert[]

  @@map("alert_configurations")
}

enum AlertType {
  cpu_usage
  memory_usage
  pod_restart
  pod_crash
  deployment_failed
  node_not_ready
  pvc_capacity
  custom
}

model Alert {
  id              Int                @id @default(autoincrement())
  configurationId Int
  configuration   AlertConfiguration @relation(fields: [configurationId], references: [id])
  namespace       String             @db.VarChar(100)
  resourceName    String             @db.VarChar(255)
  message         String             @db.Text
  value           Decimal            @db.Decimal(10, 2)
  severity        AlertSeverity
  acknowledged    Boolean            @default(false)
  acknowledgedAt  DateTime?          @db.Timestamptz(6)
  resolvedAt      DateTime?          @db.Timestamptz(6)
  createdAt       DateTime           @default(now()) @db.Timestamptz(6)

  @@index([configurationId])
  @@index([namespace])
  @@index([createdAt])
  @@index([acknowledged])
  @@map("alerts")
}

enum AlertSeverity {
  info
  warning
  critical
}

// ==================== Saved Log Filters ====================

model SavedLogFilter {
  id          Int      @id @default(autoincrement())
  name        String   @db.VarChar(255)
  namespace   String?  @db.VarChar(100)
  podName     String?  @db.VarChar(255)
  container   String?  @db.VarChar(255)
  searchQuery String?  @db.Text
  logLevel    String?  @db.VarChar(20) // info, warn, error, debug
  timeRange   String?  @db.VarChar(50) // e.g., "1h", "24h", "7d"
  isDefault   Boolean  @default(false)
  userId      Int
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now()) @db.Timestamptz(6)
  updatedAt   DateTime @updatedAt @db.Timestamptz(6)

  @@index([userId])
  @@map("saved_log_filters")
}

// ==================== Uptime Tracking ====================

model UptimeRecord {
  id          Int      @id @default(autoincrement())
  namespace   String   @db.VarChar(100)
  serviceName String   @db.VarChar(255)
  status      String   @db.VarChar(20) // up, down, degraded
  responseMs  Int?
  checkType   String   @db.VarChar(50) // http, tcp, pod_ready
  message     String?  @db.Text
  recordedAt  DateTime @default(now()) @db.Timestamptz(6)

  @@index([namespace, serviceName])
  @@index([recordedAt])
  @@map("uptime_records")
}

// ==================== Metrics Snapshots (for historical graphs) ====================

model MetricSnapshot {
  id          Int      @id @default(autoincrement())
  namespace   String   @db.VarChar(100)
  podName     String   @db.VarChar(255)
  container   String?  @db.VarChar(255)
  cpuUsage    Decimal  @db.Decimal(10, 4) // cores
  cpuLimit    Decimal  @db.Decimal(10, 4)
  memoryUsage BigInt // bytes
  memoryLimit BigInt
  recordedAt  DateTime @default(now()) @db.Timestamptz(6)

  @@index([namespace, podName])
  @@index([recordedAt])
  @@map("metric_snapshots")
}
